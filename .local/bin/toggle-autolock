#!/bin/bash
#
# This script enables / disables autolock with swayidle.
# It is intended to be used with i3status-rust, being triggered by a toggle
# block and returning a status (with the -s option) to the toggle block.

SWAYIDLE_STATUS=false

SHOW_STATUS=false

while getopts s-: arg; do
  case $arg in
  s)
    SHOW_STATUS=true
    ;;
  -)
    case $OPTARG in
    status)
      SHOW_STATUS=true
      ;;
    '') break ;; # "--" terminates argument processing
    *)
      echo "Illegal option --$OPTARG" >&2
      exit 2
      ;;
    esac
    ;;
  \?) exit 2 ;; # getopts already reported the illegal option
  esac
done
shift $((OPTIND - 1)) # remove parsed options and args from $@ list

function enable_autolock() {
  systemctl --user start swayidle
  SWAYIDLE_STATUS=true
}

function disable_autolock() {
  systemctl --user stop swayidle
  SWAYIDLE_STATUS=false
}

function update_status() {
  SWAYIDLE_STATUS=$([ $(pgrep -x swayidle) ] && echo "true" || echo "false")
}

update_status

if [ "$SHOW_STATUS" == true ]; then
  # i3status-rust toggle blocks need exit code 0 and a return of "" for "false"
  # or "something" for "true"
  if [ "$SWAYIDLE_STATUS" == true ]; then
    echo true
    exit 0
  else
    exit 0
  fi
fi

if [ "$SWAYIDLE_STATUS" == false ]; then
  enable_autolock
  exit 0
else
  disable_autolock
  exit 0
fi
